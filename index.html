<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LOK CHAT</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
body {margin:0;font-family:'Fredoka One', cursive;background:linear-gradient(135deg,#00335a,#005a9e);color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;}
canvas#particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;}
.container{width:90%;max-width:400px;background:rgba(0,50,80,0.85);backdrop-filter:blur(15px);border-radius:20px;box-shadow:0 5px 20px rgba(0,255,255,0.3);display:flex;flex-direction:column;padding:20px;box-sizing:border-box;overflow:hidden;position:relative;z-index:1;}
h1{text-align:center;margin:0 0 15px 0;color:#00f0ff;font-size:1.8rem;}
input,#messageInput{width:100%;padding:10px 12px;margin:8px 0;border-radius:15px;border:none;font-size:1em;outline:none;background-color: rgba(255,255,255,0.15);color:#fff;box-shadow: inset 0 0 10px rgba(255,255,255,0.2);box-sizing:border-box;}
button{border-radius:15px;background:linear-gradient(135deg,#00f0ff,#00c0ff);box-shadow:0 5px 15px rgba(0,240,255,0.3);border:none;font-weight:bold;cursor:pointer;transition:0.3s;}
button:hover{transform:scale(1.05);box-shadow:0 8px 20px rgba(0,240,255,0.5);}
button.smallBtn{padding:5px 10px;font-size:0.85em;margin-left:5px;}
#chatBox{flex-grow:0;height:250px;overflow-y:auto;padding:12px;background: rgba(255,255,255,0.05);border-radius:15px;margin-bottom:10px;box-shadow: inset 0 0 10px rgba(255,255,255,0.1);display:flex;flex-direction:column;justify-content:flex-end;}
.messageCard{background: rgba(0,150,255,0.2);border-radius:15px;padding:8px 12px;margin:4px 0;word-wrap: break-word;}
.adminMsg{background: rgba(0,255,255,0.4);color:#000;font-weight:bold;}
.chatInputWrapper{display:flex;gap:5px;}
#messageInput{flex:1;min-height:35px;border-radius:15px;padding:8px;background: rgba(255,255,255,0.15);color:#fff;}
.modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background: rgba(0,50,80,0.95);padding:15px;border-radius:15px;z-index:10;width:90%;max-width:350px;max-height:70%;overflow-y:auto;box-sizing:border-box;}
.modal h3{font-size:1.2rem;margin-bottom:10px;}
.modal button{font-size:0.85rem;padding:5px 8px;margin-top:5px;}
.userCard{background: rgba(0,150,255,0.2);padding:5px 10px;border-radius:10px;margin:3px 0;display:flex;justify-content:space-between;align-items:center;}
  /* 관리자 채팅 스크롤 */
  #adminChat {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 5px;
    padding: 5px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
  }
</style>
</head>
<body>
<canvas id="particles"></canvas>

<div class="container" id="authContainer">
  <h1>LOK CHAT</h1>
  <div id="registerDiv">
    <input type="text" id="regEmail" placeholder="이메일">
    <input type="password" id="regPassword" placeholder="비밀번호">
    <button onclick="register()">회원가입</button>
    <a href="#" onclick="showLogin();return false;">이미 계정이 있나요? 로그인</a>
  </div>
  <div id="loginDiv" style="display:none;">
    <input type="text" id="loginEmail" placeholder="이메일">
    <input type="password" id="loginPassword" placeholder="비밀번호">
    <button onclick="login()">로그인</button>
    <a href="#" onclick="showRegister();return false;">계정이 없나요? 회원가입</a>
  </div>
</div>

<div class="container" id="chatContainer" style="display:none;">
  <h1>CHAT</h1>
  <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
    <button class="smallBtn" onclick="showProfile()">프로필</button>
    <button class="smallBtn" id="adminBtn" style="display:none;" onclick="showAdminModal()">관리자</button>
  </div>
  <div id="chatBox"></div>
  <div class="chatInputWrapper">
    <div id="messageInput" contenteditable="true" placeholder="메시지 입력"></div>
    <button class="smallBtn" onclick="sendMessage()">전송</button>
  </div>
  <button style="margin-top:10px;" onclick="logout()">로그아웃</button>
</div>

<div class="modal" id="profileModal">
  <h3>프로필</h3>
  <div>닉네임: <input type="text" id="nickInput"></div>
  <button onclick="saveNickname()">저장</button>
  <button onclick="closeProfile()">닫기</button>
</div>

<div class="modal" id="adminModal">
  <h3>관리자 패널</h3>
  <div id="adminUsers"></div>
  <div id="adminChat"></div>
  <button onclick="closeAdmin()">닫기</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyA3IkoxfICMFwY5UAZVHUttGnE-4L9eukg",
  authDomain:"magic-c2c84.firebaseapp.com",
  projectId:"magic-c2c84",
  storageBucket:"magic-c2c84.appspot.com",
  messagingSenderId:"36602056249",
  appId:"1:36602056249:web:7436a851e3697a7b8507e8",
  measurementId:"G-WM4EYE59JN"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();
const admins=["9mLK003Be4hjoSPTIL4U9RebaFO2","ADMIN_UID_2"];
let currentUser=null;
let nicknames={};

// 파티클
const canvas=document.getElementById('particles');
const ctx=canvas.getContext('2d');
canvas.width=window.innerWidth; canvas.height=window.innerHeight;
const particles=[];
for(let i=0;i<100;i++){particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,radius:Math.random()*2+1,speedX:(Math.random()-0.5)*0.5,speedY:(Math.random()-0.5)*0.5,alpha:Math.random()});}
function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);particles.forEach(p=>{p.x+=p.speedX;p.y+=p.speedY;if(p.x<0)p.x=canvas.width;if(p.x>canvas.width)p.x=0;if(p.y<0)p.y=canvas.height;if(p.y>canvas.height)p.y=0;ctx.beginPath();ctx.arc(p.x,p.y,p.radius,0,Math.PI*2);ctx.fillStyle=`rgba(0,200,255,${p.alpha})`;ctx.fill();});requestAnimationFrame(animate);}
animate();
window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;});

// 로그인/회원가입
function showLogin(){document.getElementById('registerDiv').style.display='none';document.getElementById('loginDiv').style.display='block';}
function showRegister(){document.getElementById('registerDiv').style.display='block';document.getElementById('loginDiv').style.display='none';}
function register(){
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPassword').value;
  if(!email||!pass){alert('모든 항목 입력');return;}
  auth.createUserWithEmailAndPassword(email,pass).then(()=>{alert('회원가입 완료! 로그인하세요.');showLogin();}).catch(e=>alert(e.message));
}
function login(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPassword').value;
  if(!email||!pass){alert('모든 항목 입력');return;}
  auth.signInWithEmailAndPassword(email,pass).then(userCredential=>{
    currentUser=userCredential.user;
    document.getElementById('authContainer').style.display='none';
    document.getElementById('chatContainer').style.display='flex';
    if(admins.includes(currentUser.uid)) document.getElementById('adminBtn').style.display='inline-block';
    db.ref('users/'+currentUser.uid).once('value').then(snap=>{
      const data=snap.val()||{};
      const nick=data.nick||currentUser.email;
      nicknames[currentUser.uid]=nick;
      db.ref('users/'+currentUser.uid).set({nick,email:currentUser.email});
      listenMessages();
    });
  }).catch(e=>alert(e.message));
}
function logout(){auth.signOut().then(()=>{currentUser=null;document.getElementById('chatContainer').style.display='none';document.getElementById('authContainer').style.display='flex';});}

// 채팅
function sendMessage(){
  const text=document.getElementById('messageInput').innerText.trim();
  if(!text||!currentUser) return;
  db.ref('messages').push({uid:currentUser.uid,text,nick:nicknames[currentUser.uid],admin:admins.includes(currentUser.uid),timestamp:Date.now()});
  document.getElementById('messageInput').innerText='';
}

function listenMessages(){
  const chatBox=document.getElementById('chatBox');
  chatBox.innerHTML='';

  // 추가 및 삭제 처리
  db.ref('messages').off();
  db.ref('messages').on('child_added',snapshot=>{
    const msg=snapshot.val();
    const div=document.createElement('div');
    div.className='messageCard';
    if(msg.admin) div.className+=' adminMsg';
    div.id=snapshot.key;
    div.dataset.uid=msg.uid;
    div.textContent=`[${msg.nick||msg.uid}] ${msg.text}`;
    chatBox.appendChild(div);
    chatBox.scrollTop=chatBox.scrollHeight;
  });
  db.ref('messages').on('child_removed',snapshot=>{
    const div=document.getElementById(snapshot.key);
    if(div) div.remove();
  });

  // 닉네임 변경
  db.ref('users').on('child_changed',snap=>{
    const uid=snap.key;
    const newNick=snap.val().nick;
    nicknames[uid]=newNick;
    const messages=chatBox.querySelectorAll('.messageCard');
    messages.forEach(div=>{
      if(div.dataset.uid===uid){
        const text=div.textContent.split('] ')[1];
        div.textContent=`[${newNick}] ${text}`;
      }
    });
  });
}

// 프로필
function showProfile(){document.getElementById('profileModal').style.display='block';db.ref('users/'+currentUser.uid).once('value').then(snap=>{document.getElementById('nickInput').value=snap.val().nick||currentUser.email;});}
function closeProfile(){document.getElementById('profileModal').style.display='none';}
function saveNickname(){const nick=document.getElementById('nickInput').value.trim()||currentUser.email;db.ref('users/'+currentUser.uid).update({nick});closeProfile();}

function showAdminModal(){
  const modal = document.getElementById('adminModal');
  modal.style.display = 'block';

  // 유저 목록
  const usersDiv = document.getElementById('adminUsers'); 
  usersDiv.innerHTML = '<h4>유저 목록</h4>';

  db.ref('users').once('value').then(snap=>{
    const users = snap.val() || {};
    Object.keys(users).forEach(uid=>{
      const u = users[uid];
      const div = document.createElement('div');
      div.className = 'userCard';
      div.textContent = `${u.nick} / ${u.email}`;
      usersDiv.appendChild(div);
    });
  });

  // 채팅 관리
  const chatDiv = document.getElementById('adminChat'); 
  chatDiv.innerHTML = '<h4>채팅 관리</h4>';

  db.ref('messages').orderByChild('timestamp').once('value').then(snap=>{
    const msgs = snap.val() || {};
    const sortedKeys = Object.keys(msgs).sort((a,b)=>msgs[b].timestamp - msgs[a].timestamp); // 최신 상단
    sortedKeys.forEach(k=>{
      const m = msgs[k];
      const div = document.createElement('div');
      div.className = 'userCard';
      div.textContent = `[${m.nick}] ${m.text}`;

      const btn = document.createElement('button');
      btn.textContent = '삭제';
      btn.onclick = () => { db.ref('messages/'+k).remove(); showAdminModal(); };
      div.appendChild(btn);
      chatDiv.appendChild(div);
    });
  });

  // **닫기 버튼 이벤트 연결**
  document.getElementById('adminModal').querySelector('button:last-child').onclick = closeAdmin;
}

function closeAdmin(){
  document.getElementById('adminModal').style.display = 'none';
}
</script>
</body>
</html>